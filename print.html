<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The DarkFi Book</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">DarkFi</a></li><li class="chapter-item expanded "><a href="IDEOLOGY.html"><strong aria-hidden="true">1.</strong> Ideology</a></li><li class="chapter-item expanded "><a href="development.html"><strong aria-hidden="true">2.</strong> Development</a></li><li class="chapter-item expanded "><a href="tutorial.html"><strong aria-hidden="true">3.</strong> Tutorial</a></li><li class="chapter-item expanded "><a href="architecture/architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="architecture/nodes.html"><strong aria-hidden="true">4.1.</strong> Node design</a></li></ol></li><li class="chapter-item expanded "><a href="clients/clients.html"><strong aria-hidden="true">5.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="clients/darkfid_jsonrpc.html"><strong aria-hidden="true">5.1.</strong> darkfid JSON-RPC API</a></li><li class="chapter-item expanded "><a href="clients/cashierd_jsonrpc.html"><strong aria-hidden="true">5.2.</strong> cashierd JSON-RPC API</a></li></ol></li><li class="chapter-item expanded "><a href="zkas/zkas.html"><strong aria-hidden="true">6.</strong> zkas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zkas/bincode.html"><strong aria-hidden="true">6.1.</strong> Bincode</a></li><li class="chapter-item expanded "><a href="zkas/examples.html"><strong aria-hidden="true">6.2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="zkas/examples/sapling.html"><strong aria-hidden="true">6.2.1.</strong> Sapling scheme</a></li><li class="chapter-item expanded "><a href="zkas/examples/voting.html"><strong aria-hidden="true">6.2.2.</strong> Anonymous voting</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <!-- Make the book title only appear if it is *not* the chapter title as well -->
                    <h1 id="book-title" class="menu-title">The DarkFi Book</h1>
                    <script type="text/javascript">
                        var bookTitleElement = document.getElementById('book-title')
                        var bookTitle = 'The DarkFi Book';
                        var chapterTitle = '';
                        if (bookTitle === chapterTitle) {
                            bookTitleElement.innerText = null;
                            document.title = bookTitle;
                        }
                    </script>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfi"><a class="header" href="#darkfi">DarkFi</a></h1>
<p><img src="https://img.shields.io/github/workflow/status/darkrenaissance/darkfi/CI%20Checks?style=flat-square" alt="Build Status" />
<a href="https://dark.fi"><img src="https://img.shields.io/badge/Web-dark.fi-white?logo=firefox&amp;logoColor=white&amp;style=flat-square" alt="Web - dark.fi" /></a>
<a href="https://lists.dyne.org/lurker/message/20211021.123016.3dccaf0c.en.html"><img src="https://img.shields.io/badge/Manifesto-unsystem-informational?logo=minutemailer&amp;logoColor=white&amp;style=flat-square" alt="Manifesto - unsystem" /></a>
<a href="https://darkrenaissance.github.io/darkfi"><img src="https://img.shields.io/badge/Book-mdbook-orange?logo=gitbook&amp;logoColor=white&amp;style=flat-square" alt="Book - mdbook" /></a></p>
<h2 id="build"><a class="header" href="#build">Build</a></h2>
<p>This project requires the Rust compiler to be installed. 
Please visit https://rustup.rs/ for instructions.</p>
<p>The following dependencies are also required:</p>
<table><thead><tr><th>Dependency</th><th>Debian-based</th></tr></thead><tbody>
<tr><td>gcc, gcc-c++, kernel headers</td><td>build-essential</td></tr>
<tr><td>cmake</td><td>cmake</td></tr>
<tr><td>wget</td><td>wget</td></tr>
<tr><td>pkg-config</td><td>pkg-config</td></tr>
<tr><td>clang</td><td>clang</td></tr>
<tr><td>clang libs</td><td>libclang-dev</td></tr>
<tr><td>llvm libs</td><td>llvm-dev</td></tr>
<tr><td>udev libs</td><td>libudev-dev</td></tr>
<tr><td>freetype2 libs</td><td>libfreetype6-dev</td></tr>
<tr><td>expat xml lib</td><td>libexpat1-dev</td></tr>
</tbody></table>
<p>Users of Debian-based systems (e.g. Ubuntu) can simply run the following 
to install the required dependencies:</p>
<pre><code class="language-shell">% sudo apt-get update
% sudo apt-get install -y build-essential cmake wget pkg-config clang \
    libclang-dev llvm-dev libudev-dev libfreetype6-dev libexpat1-dev
</code></pre>
<p>To build the necessary binaries, we can just clone the repo, and use the 
provided Makefile to build the project. This will download the trusted 
setup params, and compile the source code.</p>
<pre><code class="language-shell">% git clone https://github.com/darkrenaissance/darkfi
% cd darkfi/
% make
</code></pre>
<h2 id="development"><a class="header" href="#development">Development</a></h2>
<p>If you want to hack on the source code, make sure to read some
introductory advice in the
<a href="https://darkrenaissance.github.io/darkfi/development.html">DarkFi book</a>.</p>
<h2 id="install"><a class="header" href="#install">Install</a></h2>
<p>This will install the binaries on your system (<code>/usr/local</code> by
default). The configuration files for the binaries are bundled with the
binaries and contain sane defaults. You'll have to run each daemon once
in order for them to spawn a config file, which you can then review.</p>
<pre><code class="language-shell">% sudo make install
</code></pre>
<h2 id="bash-completion"><a class="header" href="#bash-completion">Bash Completion</a></h2>
<p>This will add the options auto completion of <code>drk</code> and <code>darkfid</code>.</p>
<pre><code class="language-shell">% echo source (pwd)/contrib/auto-complete &gt;&gt; ~/.bashrc
</code></pre>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>After the installation, you should have <code>drk</code> and <code>darkfid</code> binaries in
<code>/usr/local</code>. Trying to run them once should place the configuration
files in their respective path. Now we're ready to use the testnet.</p>
<p>In one terminal, start <code>darkfid</code>, which is the daemon that will
communicate with the DarkFi network:</p>
<pre><code class="language-shell">% darkfid -v
</code></pre>
<p>And in the other terminal, we can use the CLI interface to <code>darkfid</code>
called <code>drk</code>:</p>
<pre><code>% drk -h
drk 0.2.0
darkfi &lt;dev@dark.fi&gt;
Anonymous. Uncensored. Sovereign.

USAGE:
    drk [OPTIONS] &lt;SUBCOMMAND&gt;

OPTIONS:
    -c, --config &lt;CONFIG&gt;    Sets a custom config file
    -h, --help               Print help information
    -v                       Increase verbosity
    -V, --version            Print version information

SUBCOMMANDS:
    deposit     Deposit clear tokens for Dark tokens
    features    Show what features the cashier supports
    hello       Say hello to the RPC
    help        Print this message or the help of the given subcommand(s)
    id          Get hexidecimal ID for token symbol
    transfer    Transfer Dark tokens to address
    wallet      Wallet operations
    withdraw    Withdraw Dark tokens for clear tokens
</code></pre>
<h3 id="examples"><a class="header" href="#examples">Examples</a></h3>
<p>See the <a href="https://darkrenaissance.github.io/darkfi">DarkFi book</a></p>
<h2 id="go-dark"><a class="header" href="#go-dark">Go Dark</a></h2>
<p>Let's liberate people from the claws of big tech and create the
democratic paradigm of technology.</p>
<p>Self-defense is integral to any organism's survival and growth.</p>
<p>Power to the minuteman.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="definition-of-democratic-civilization"><a class="header" href="#definition-of-democratic-civilization">Definition of Democratic Civilization</a></h1>
<p>From 'The Sociology of Freedom: Manifesto of the Democratic
Civilization, Volume 3' by Abdullah Ocalan.</p>
<p>Annotations are our own. The text is otherwise unchanged.</p>
<h2 id="what-is-the-subject-of-moral-and-political-society"><a class="header" href="#what-is-the-subject-of-moral-and-political-society">What is the subject of moral and political society?</a></h2>
<p>The school of social science that postulates the examination of the
existence and development of social nature on the basis of moral and
political society could be defined as the democratic civilization
system. The various schools of social science base their analyses
on different units.  Theology and religion prioritize society. For
scientific socialism, it is class.  The fundamental unit for liberalism
is the individual. There are, of course, schools that prioritize
power and the state and others that focus on civilization.  All these
unit-based approaches must be criticized, because, as I have frequently
pointed out, they are not historical, and they fail to address the
totality. A meaningful examination would have to focus on what is
crucial from the point of view of society, both in terms of history
and actuality. Otherwise, the result will only be one more discourse.</p>
<p>Identifying our fundamental unit as moral and political society is
significant, because it also covers the dimensions of historicity
and totality.  Moral and political society is the most historical and
holistic expression of society. Morals and politics themselves can
be understood as history.  A society that has a moral and political
dimension is a society that is the closest to the totality of all its
existence and development. A society can exist without the state,
class, exploitation, the city, power, or the nation, but a society
devoid of morals and politics is unthinkable. Societies may exist as
colonies of other powers, particularly capital and state monopolies,
and as sources of raw materials. In those cases, however, we are
talking about the legacy of a society that has ceased to be.</p>
<h2 id="individualism-is-a-state-of-war"><a class="header" href="#individualism-is-a-state-of-war">Individualism is a state of war</a></h2>
<p>There is nothing gained by labeling moral and political society—the
natural state of society—as slave-owning, feudal, capitalist,
or socialist.  Using such labels to describe society masks
reality and reduces society to its components (class, economy, and
monopoly). The bottleneck encountered in discourses based on such
concepts as regards the theory and practice of social development
stems from errors and inadequacies inherent in them. If all of the
analyses of society referred to with these labels that are closer to
historical materialism have fallen into this situation, it is clear
that discourses with much weaker scientific bases will be in a much
worse situation. Religious discourses, meanwhile, focus heavily on
the importance of morals but have long since turned politics over to
the state.  Bourgeois liberal approaches not only obscure the society
with moral and political dimensions, but when the opportunity presents
itself they do not hesitate to wage war on this society. Individualism
is a state of war against society to the same degree as power and the
state is. Liberalism essentially prepares society, which is weakened
by being deprived of its morals and politics, for all kinds of attacks
by individualism. Liberalism is the ideology and practice that is
most anti-society.</p>
<h2 id="the-rise-of-scientific-positivism"><a class="header" href="#the-rise-of-scientific-positivism">The rise of scientific positivism</a></h2>
<p>In Western sociology (there is still no science called Eastern
sociology) concepts such as society and civilization system are
quite problematic.  We should not forget that the need for sociology
stemmed from the need to find solutions to the huge problems of
crises, contradictions, and conflicts and war caused by capital and
power monopolies. Every branch of sociology developed its own thesis
about how to maintain order and make life more livable. Despite
all the sectarian, theological, and reformist interpretations
of the teachings of Christianity, as social problems deepened,
interpretations based on a scientific (positivist) point of view
came to the fore. The philosophical revolution and the Enlightenment
(seventeenth and eighteenth centuries) were essentially the result
of this need.  When the French Revolution complicated society’s
problems rather than solving them, there was a marked increase in
the tendency to develop sociology as an independent science. Utopian
socialists (Henri de Saint-Simon, Charles Fourier, and Pierre-Joseph
Proudhon), together with Auguste Comte and Émile Durkheim, represent
the preliminary steps in this direction.  All of them are children
of the Enlightenment, with unlimited faith in science. They believed
they could use science to re-create society as they wished. They
were playing God. In Hegel’s words, God had descended to earth
and, what’s more, in the form of the nation-state. What needed to
be done was to plan and develop specific and sophisticated “social
engineering” projects. There was no project or plan that could not be
achieved by the nation-state if it so desired, as long as it embraced
the “scientific positivism” and was accepted by the nation-state!</p>
<h2 id="capitalism-as-an-iron-cage"><a class="header" href="#capitalism-as-an-iron-cage">Capitalism as an iron cage</a></h2>
<p>British social scientists (political economists) added economic
solutions to French sociology, while German ideologists contributed
philosophically.  Adam Smith and Hegel in particular made major
contributions.  There was a wide variety of prescriptions from
both the left and right to address the problems arising from the
horrendous abuse of the society by the nineteenth-century industrial
capitalism. Liberalism, the central ideology of the capitalist
monopoly has a totally eclectic approach, taking advantage of any
and all ideas, and is the most practical when it comes to creating
almost patchwork-like systems. It was as if the right- and left-
wing schematic sociologies were unaware of social nature, history,
and the present while developing their projects in relation to the
past (the quest for the “golden age” by the right) or the future
(utopian society). Their systems would continually fragment when they
encountered history or current life. The reality that had imprisoned
them all was the “iron cage” that capitalist modernity had slowly
cast and sealed them in, intellectually and in their practical way
of life. However, Friedrich Nietzsche’s ideas of metaphysicians
of positivism or castrated dwarfs of capitalist modernity bring us
a lot closer to the social truth. Nietzsche leads the pack of rare
philosophers who first drew attention to the risk of society being
swallowed up by capitalist modernity. Although he is accused of
serving fascism with his thoughts, his foretelling of the onset of
fascism and world wars was quite enticing.</p>
<p>The increase in major crises and world wars, along with the division of
the liberal center into right- and left-wing branches, was enough to
bankrupt positivist sociology. In spite of its widespread criticism
of metaphysics, social engineering has revealed its true identity
with authoritarian and totalitarian fascism as metaphysics at
its shallowest.  The Frankfurt School is the official testimonial
of this bankruptcy. The École Annales and the 1968 youth uprising
led to various postmodernist sociological approaches, in particular
Immanuel Wallerstein’s capitalist world-system analysis. Tendencies
like ecology, feminism, relativism, the New Left, and world-system
analysis launched a period during which the social sciences
splintered. Obviously, financial capital gaining hegem- ony as
the 1970s faded also played an important role. The upside of these
developments was the collapse of the hegemony of Eurocentric thought.
The downside, however, was the drawbacks of a highly fragmented
social sciences.</p>
<h2 id="the-problems-of-eurocentric-sociology"><a class="header" href="#the-problems-of-eurocentric-sociology">The problems of Eurocentric sociology</a></h2>
<p>Let’s summarize the criticism of Eurocentric sociology:</p>
<ol>
<li>
<p>Positivism, which criticized and denounced both religion and
metaphysics, has not escaped being a kind of religion and metaphysics
in its own right. This should not come as a surprise.  Human culture
requires metaphysics. The issue is to distinguish good from bad
metaphysics.</p>
</li>
<li>
<p>An understanding of society based on dichotomies like primitive vs.
modern, capitalist vs. socialist, industrial vs. agrarian, progressive
vs. reactionary, divided by class vs. classless, or with a state
vs. stateless prevents the development of a definition that comes
closer to the truth of social nature. Dichotomies of this sort distance
us from social truth.</p>
</li>
<li>
<p>To re-create society is to play the modern god. More precisely, each
time society is recreated there is a tendency to form a new capital
and power-state monopoly. Much like medieval theism was ideologically
connected to absolute monarchies (sultanates and shāhanshāhs),
modern social engineering—as re-creation— is essentially the
divine disposition and ideology of the nation- state. Positivism in
this regard is modern theism.</p>
</li>
<li>
<p>Revolutions cannot be interpreted as the re-creation acts of
society. When thusly understood they cannot escape positivist
theism. Revolutions can only be defined as social revolutions to
the extent that they free society from excessive burden of capital
and power.</p>
</li>
<li>
<p>The task of revolutionaries cannot be defined as creating any
social model of their making but more correctly as playing a role in
contributing to the development of moral and political society.</p>
</li>
<li>
<p>Methods and paradigms to be applied to social nature should not be
identical to those that relate to first nature. While the universalist
approach to first nature provides results that come closer to the
truth (I don’t believe there is an absolute truth), relativism in
relation to social nature may get us closer to the truth. The universe
can neither be explained by an infinite universalist linear discourse
or by a concept of infinite similar circular cycles.</p>
</li>
<li>
<p>A social regime of truth needs to be reorganized on the basis of
these and many other criticisms. Obviously, I am not talking about
a new divine creation, but I do believe that the greatest feature of
the human mind is the power to search for and build truth.</p>
</li>
</ol>
<h2 id="a-new-social-science"><a class="header" href="#a-new-social-science">A new social science</a></h2>
<p>In light of these criticisms, I offer the following suggestions in
relation to the social science system that I want to define:</p>
<h3 id="a-more-humane-social-nature"><a class="header" href="#a-more-humane-social-nature">A more humane social nature</a></h3>
<ol>
<li>
<p>I would not present social nature as a rigid universalist truth with
mythological, religious, metaphysical, and scientific (positivist)
patterns. Understanding it to be the most flexible form of basic
universal entities that encompass a wealth of diversities but are
tied down to conditions of historical time and location more closely
approaches the truth. Any analysis, social science, or attempt to make
practical change without adequate knowledge of the qualities of social
nature may well backfire. The monotheistic religions and positivism,
which have appeared throughout the history of civilization claiming
to have found the solution, were unable to prevent capital and power
monopolies from gaining control. It is therefore their irrevocable
task, if they are to contribute to moral and political society,
to develop a more humane analysis based on a profound self-criticism.</p>
</li>
<li>
<p>Moral and political society is the main element that gives social
nature its historical and complete meaning and represents the unity in
diversity that is basic to its existence. It is the definition of moral
and political society that gives social nature its character, maintains
its unity in diversity, and plays a decisive role in expressing its
main totality and historicity. The descriptors commonly used to define
society, such as primitive, modern, slave-owning, feudal, capitalist,
socialist, industrial, agricultural, commercial, monetary, statist,
national, hegemonic, and so on, do not reflect the decisive features
of social nature. On the contrary, they conceal and fragment its
meaning. This, in turn, provides a base for faulty theoretical and
practical approaches and actions related to society.</p>
</li>
</ol>
<h3 id="protecting-the-social-fabric"><a class="header" href="#protecting-the-social-fabric">Protecting the social fabric</a></h3>
<ol start="3">
<li>
<p>Statements about renewing and re-creating society are part of
operations meant to constitute new capital and power monopolies in
terms of their ideological content. The history of civilization, the
history of such renewals, is the history of the cumulative accumulation
of capital and power. Instead of divine creativity, the basic action
the society needs most is to struggle against factors that prevent the
development and functioning of moral and political social fabric. A
society that operates its moral and political dimensions freely,
is a society that will continue its development in the best way.</p>
</li>
<li>
<p>Revolutions are forms of social action resorted to when society
is sternly prevented from freely exercising and maintaining its
moral and political function. Revolutions can and should be accepted
as legitimate by society only when they do not seek to create new
societies, nations, or states but to restore moral and political
society its ability to function freely.</p>
</li>
<li>
<p>Revolutionary heroism must find meaning through its contributions
to moral and political society. Any action that does not have this
meaning, regardless of its intent and duration, cannot be defined as
revolutionary social heroism. What determines the role of individuals
in society in a positive sense is their contribution to the development
of moral and political society.</p>
</li>
<li>
<p>No social science that hopes to develop these key features through
profound research and examination should be based on a universalist
linear progressive approach or on a singular infinite cyclical
relativity. In the final instance, instead of these dogmatic approaches
that serve to legitimize the cumulative accumulation of capital and
power throughout the history of civilization, social sciences based
on a non-destructive dialectic methodology that harmonizes analytical
and emotional intelligence and overcomes the strict subject-object
mold should be developed.</p>
</li>
</ol>
<h2 id="the-framework-of-moral-and-political-society"><a class="header" href="#the-framework-of-moral-and-political-society">The framework of moral and political society</a></h2>
<p>The paradigmatic and empirical framework of moral and political
society, the main unit of the democratic civilization system, can be
presented through such hypotheses. Let me present its main aspects:</p>
<ol>
<li>
<p>Moral and political society is the fundamental aspect of human
society that must be continuously sought. Society is essentially
moral and political.</p>
</li>
<li>
<p>Moral and political society is located at the opposite end of the
spectrum from the civilization systems that emerged from the triad
of city, class, and state (which had previously been hierarchical
structures).</p>
</li>
<li>
<p>Moral and political society, as the history of social nature,
develops in harmony with the democratic civilization system.</p>
</li>
<li>
<p>Moral and political society is the freest society. A functioning
moral and political fabric and organs is the most decisive dynamic
not only for freeing society but to keep it free. No revolution or
its heroines and heroes can free the society to the degree that the
development of a healthy moral and political dimension will.  Moreover,
revolution and its heroines and heroes can only play a decisive role
to the degree that they contribute to moral and political society.</p>
</li>
<li>
<p>A moral and political society is a democratic society. Democracy
is only meaningful on the basis of the existence of a moral and
political society that is open and free. A democratic society where
individuals and groups become subjects is the form of governance
that best develops moral and political society. More precisely,
we call a functioning political society a democracy. Politics and
democracy are truly identical concepts. If freedom is the space within
which politics expresses itself, then democracy is the way in which
politics is exercised in this space. The triad of freedom, politics,
and democracy cannot lack a moral basis. We could refer to morality
as the institutionalized and traditional state of freedom, politics,
and democracy.</p>
</li>
<li>
<p>Moral and political societies are in a dialectical contradiction
with the state, which is the official expression of all forms of
capital, property, and power. The state constantly tries to substitute
law for morality and bureaucracy for politics. The official state
civilization develops on one side of this historically ongoing
contradiction, with the unofficial democratic civilization system
developing on the other side. Two distinct typologies of meaning
emerge.  Contradictions may either grow more violent and lead to war
or there may be reconciliation, leading to peace.</p>
</li>
<li>
<p>Peace is only possible if moral and political society forces
and the state monopoly forces have the will to live side by side
unarmed and with no killing. There have been instances when rather
than society destroying the state or the state destroying society,
a conditional peace called democratic reconciliation has been
reached. History doesn’t take place either in the form of democratic
civilization—as the expression of moral and political society—or
totally in the form of civilization systems—as the expression of
class and state society. History has unfolded as intense relationship
rife with contradiction between the two, with successive periods of
war and peace. It is quite utopian to think that this situation, with
at least a five-thousand-year history, can be immediately resolved
by emergency revolutions. At the same time, to embrace it as if it
is fate and cannot be interfered with would also not be the correct
moral and political approach.  Knowing that struggles between systems
will be protracted, it makes more sense and will prove more effective
to adopt strategic and tactical approaches that expand the freedom
and democracy sphere of moral and political society.</p>
</li>
<li>
<p>Defining moral and political society in terms of communal,
slave-owning, feudal, capitalist, and socialist attributes serves
to obscure rather than elucidate matters. Clearly, in a moral and
political society there is no room for slave-owning, feudal, or
capitalist forces, but, in the context of a principled reconciliation,
it is possible to take an aloof approach to these forces, within
limits and in a controlled manner. What’s important is that moral
and political society should neither destroy them nor be swallowed up
by them; the superiority of moral and political society should make
it possible to continuously limit the reach and power of the central
civilization system. Communal and socialist systems can identify
with moral and political society insofar as they themselves are
democratic. This identification is, however, not possible, if they
have a state.</p>
</li>
<li>
<p>Moral and political society cannot seek to become a nation-state,
establish an official religion, or construct a non-democratic
regime. The right to determine the objectives and nature of society
lies with the free will of all members of a moral and political
society. Just as with current debates and decisions, strategic
decisions are the purview of society’s moral and political will and
expression. The essential thing is to have discussions and to become
a decision-making power. A society who holds this power can determine
its preferences in the soundest possible way. No individual or force
has the authority to decide on behalf of moral and political society,
and social engineering has no place in these societies.</p>
</li>
</ol>
<h2 id="liberating-democratic-civilization-from-the-state"><a class="header" href="#liberating-democratic-civilization-from-the-state">Liberating democratic civilization from the State</a></h2>
<p>When viewed in the light of the various broad definitions I
have presented, it is obvious that the democratic civilization
system—essentially the moral and political totality of social
nature—has always existed and sustained itself as the flip side of
the official history of civilization. Despite all the oppression and
exploitation at the hands of the official world-system, the other face
of society could not be destroyed. In fact, it is impossible to destroy
it. Just as capitalism cannot sustain itself without noncapitalist
society, civilization— the official world system— also cannot
sustain itself without the democratic civilization system. More
concretely the civilization with monopolies cannot sustain itself
without the existence of a civilization without monopolies. The
opposite is not true. Democratic civilization, representing the
historical flow of the system of moral and political society, can
sustain itself more comfortably and with fewer obstacles in the
absence of the official civilization.</p>
<p>I define democratic civilization as a system of thought, the
accumulation of thought, and the totality of moral rules and political
organs. I am not only talking about a history of thought or the social
reality within a given moral and political development. The discussion
does, however, encompass both issues in an intertwined manner. I
consider it important and necessary to explain the method in terms of
democratic civilization’s history and elements, because this totality
of alternate discourse and structures are prevented by the official
civilization. I will address these issues in subsequent sections.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="notes-for-developers"><a class="header" href="#notes-for-developers">Notes for developers</a></h1>
<h2 id="making-life-easy-for-others"><a class="header" href="#making-life-easy-for-others">Making life easy for others</a></h2>
<blockquote>
<p><strong>Write useful commit messages.</strong></p>
</blockquote>
<p>If your commit is changing a specific module in the code and not
touching other parts of the codebase (as should be the case 99% of the
time), consider writing a useful commit message that also mentions
which module was changed.</p>
<p>For example, a message like:</p>
<blockquote>
<p><code>added foo</code></p>
</blockquote>
<p>is not as clear as</p>
<blockquote>
<p><code>crypto/keypair: Added foo method for Bar struct.</code></p>
</blockquote>
<p>Also keep in mind that commit messages can be longer than a single
line, so use it to your advantage to explain your commit and
intentions.</p>
<h2 id="cargo-fmt-pre-commit-hook"><a class="header" href="#cargo-fmt-pre-commit-hook">cargo fmt pre-commit hook</a></h2>
<p>To ensure every contributor uses the same code style, make sure
you run <code>cargo +nightly fmt</code> before committing. You can force yourself
to do this by creating a git <code>pre-commit</code> hook like the following:</p>
<pre><code class="language-shell">#!/bin/sh
if ! cargo +nightly fmt -- --check &gt;/dev/null; then
    echo &quot;There are some code style issues. Run 'cargo +nightly fmt' to fix it.&quot;
    exit 1
fi

exit 0
</code></pre>
<p>Place this script in <code>.git/hooks/pre-commit</code> and make sure it's
executable by running <code>chmod +x .git/hooks/pre-commit</code>.</p>
<h2 id="testing-crate-features"><a class="header" href="#testing-crate-features">Testing crate features</a></h2>
<p>Our library heavily depends on cargo <em>features</em>. Currently
there are more than 650 possible combinations of features to
build the library.  To ensure everything can always compile
and works, we can use a helper for <code>cargo</code> called
<a href="https://github.com/taiki-e/cargo-hack"><code>cargo hack</code></a>.</p>
<p>The <code>Makefile</code> provided in the repository is already set up to use it,
so it's enough to install <code>cargo hack</code> and run <code>make check</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfi-user-tutorial"><a class="header" href="#darkfi-user-tutorial">DarkFi User Tutorial</a></h1>
<p>Welcome to the dark renaissance. This tutorial will teach you how to
install darkfi on your system, and how to use the testnet to send and
receive anonymous tokens.</p>
<h2 id="download"><a class="header" href="#download">Download</a></h2>
<p>To run darkfi, we must first install the software. Do this by cloning
the darkfi repo:</p>
<pre><code>% git clone https://github.com/darkrenaissance/darkfi
</code></pre>
<h2 id="build-1"><a class="header" href="#build-1">Build</a></h2>
<p>In the project root directory, run provided Makefile. This will download
the trusted setup params and compile the source code. This might take
a while.</p>
<pre><code>% make
</code></pre>
<h2 id="install-1"><a class="header" href="#install-1">Install</a></h2>
<p>We will now install the project. This will install the binaries
and configurations in the configured namespace (<code>/usr/local</code>
by default). The configurations are installed as TOML files in
<code>/usr/local/share/doc/darkfi</code>. They have to be copied in your user's
<code>HOME/.config/darkfi</code> directory.</p>
<p>Feel free to review the installed config files, but you don't need to
change anything to run the testnet. The defaults will work fine.</p>
<pre><code>% sudo make install
% mkdir -p ~/.config/darkfi
% cp -f /usr/local/share/doc/darkfi/*.toml ~/.config/darkfi
</code></pre>
<h2 id="run"><a class="header" href="#run">Run</a></h2>
<p>Darkfi consists of several software daemons or processes. These daemons
have separate, isolated concerns.</p>
<p>As a user, your interest is in the <code>darkfid</code> daemon. This is a user
node that interacts with your wallet and communicates with services on
the darkfi network. It is operated using the <code>drk</code> command-line tool.</p>
<p>After the installation, you should have <code>drk</code> and <code>darkfid</code> binaries in
<code>/usr/local</code>. Also, the params and configuration files should be in
<code>~/.config/darkfi</code>.</p>
<p>We're now ready to use the testnet.</p>
<p>Open two terminal windows. In one terminal, start <code>darkfid</code>:</p>
<pre><code>% darkfid -v
</code></pre>
<p>And another terminal, run <code>drk</code>. This is the command-line interface to
interact with <code>darkfid</code>.</p>
<pre><code>% drk -h
drk

USAGE:
    drk [FLAGS] [OPTIONS] [SUBCOMMAND]

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information
    -v, --verbose    Increase verbosity

OPTIONS:
    -c, --config &lt;CONFIG&gt;    Sets a custom config file

SUBCOMMANDS:
    deposit     Deposit clear tokens for Dark tokens
    features    Show what features the cashier supports
    hello       Say hello to the RPC
    help        Prints this message or the help of the given subcommand(s)
    id          Get hexadecimal ID for token symbol
    transfer    Transfer Dark tokens to address
    wallet      Wallet operations
    withdraw    Withdraw Dark tokens for clear tokens
</code></pre>
<h2 id="deposit"><a class="header" href="#deposit">Deposit</a></h2>
<p>We'll go through the main features one by one. Let's start by depositing
some coins into darkfi.</p>
<p>First, we need testnet coins on either Bitcoin or Solana. For
Bitcoin these can be acquired from a faucet like <a href="https://testnet-faucet.mempool.co/">this
one</a>. You will need to switch your
Bitcoin wallet to testnet mode.</p>
<p>If you don't have a Bitcoin wallet, <a href="https://electrum.org/">Electrum</a>
is an excellent option. Configuring Electrum
for testnet depends on the operating system: see <a href="https://bitzuma.com/posts/a-beginners-guide-to-the-electrum-bitcoin-wallet/#testnet-on-ubuntu">this
tutorial</a>
for more details.</p>
<p>For Solana, you can either install the Solana command-line suite or use
<a href="https://www.sollet.io">sollet</a>.</p>
<p>Follow <a href="https://docs.solana.com/cli">this tutorial</a> for the Solana
command-line. For sollet.io, switch the network to testnet and click
'Request Airdrop' to airdrop yourself some testnet coins.</p>
<p>Now that we have testnet coins we can deposit into darkfi.</p>
<p>We'll do this by sending testnet coins to the darki cashier, which will
issue darkened versions of the deposited coin. This process of darkening
involves the cashier minting new anonymous tokens that are 1:1 redeemable
for deposits. For example, if you deposit 1 BTC, you will receive 1 dBTC,
or darkened SOL.</p>
<p>To deposit testnet BTC:</p>
<pre><code>% drk deposit btc --network bitcoin
</code></pre>
<p>To deposit testnet SOL:</p>
<pre><code>% drk deposit sol --network solana
</code></pre>
<p>To deposit any other asset:</p>
<pre><code>% drk deposit [ASSET] --network solana
</code></pre>
<p>This command will send a deposit request to the cashier. After running
it, you should get an address printed to your terminal, like this:</p>
<pre><code>Deposit your coins to the following address: &quot;734JBp3FRPoDs6ibSMyq3CV9zyMiDeynxMQRbSxVvozN&quot;
</code></pre>
<p>Using Bitcoin or Solana, deposit the desired tokens to the specified
address. Wait a moment- it should take about 30 seconds to receive your
deposit. You can follow the progress on the terminal window where you ran
<code>darkfid</code>. Then check your updated balance, like so:</p>
<pre><code>% drk wallet --balances

+-------+--------+---------+
| token | amount | network |
+-------+--------+---------+
| SOL   | 1      | solana  |
+-------+--------+---------+

</code></pre>
<h2 id="send"><a class="header" href="#send">Send</a></h2>
<p>Now that you have darkened tokens inside darkfi, you can send them
around anonymously.</p>
<p>Find a friend with an account on darkfi and ask them for their darkfi
address. Then run the transfer command:</p>
<pre><code>% drk transfer &lt;TOKEN&gt; &lt;ADDRESS&gt; &lt;AMOUNT&gt;
</code></pre>
<p>For example, to transfer 1 SOL to a user at
9GmLk7kkbxhsbLTYFMeg6FyuQJV9Na2GcJYFNrs3VLkv address, you would run the
following command:</p>
<pre><code>% drk transfer sol 9GmLk7kkbxhsbLTYFMeg6FyuQJV9Na2GcJYFNrs3VLkv 1
</code></pre>
<h2 id="receive"><a class="header" href="#receive">Receive</a></h2>
<p>To receive anonymous tokens your darkfid account, you must retrieve your
darkfi address. Send this address to others so they can send you tokens.</p>
<pre><code>% drk wallet --address
Wallet address: &quot;9GmLk7kkbxhsbLTYFMeg6FyuQJV9Na2GcJYFNrs3VLkv&quot;
</code></pre>
<h2 id="withdraw"><a class="header" href="#withdraw">Withdraw</a></h2>
<p>Withdrawing your testnet funds can be done at any time. This will exchange
your anonymous darkened tokens for their underlying collateral, i.e. if
you have 1 dBTC you will receive 1 BTC.</p>
<p>To do so, simply send the following request to the cashier:</p>
<pre><code>% drk withdraw &lt;TOKENSYM&gt; &lt;ADDRESS&gt; &lt;AMOUNT&gt; --network &lt;network&gt;
</code></pre>
<p>For example, if you want to withdraw 0.5 SOL to the Solana address
4q7rkNvH5BVs6VLz6nyhKLvqXmwDyjGnUsE5sZzRNgp4, you would write:</p>
<pre><code>% drk withdraw sol 4q7rkNvH5BVs6VLz6nyhKLvqXmwDyjGnUsE5sZzRNgp4 0.5 --network solana
</code></pre>
<p>For Bitcoin, the command would look like this:</p>
<pre><code>% drk withdraw btc bc1qw7nt2yca0zykh8a5sc6nmy3r3clx4ha206wepn 0.5 --network bitcoin
</code></pre>
<h2 id="configure"><a class="header" href="#configure">Configure</a></h2>
<p>DarkFi is highly configurable by design. Key system parameters can be
changed inside the config files.</p>
<p>This is the darkfid config file. Your local copy can be found in
<code>~/.config/darkfi</code>.</p>
<pre><code class="language-toml">## darkfid configuration file
##
## Please make sure you go through all the settings so you can configure
## your daemon properly.

# The address where darkfid should bind its RPC socket
rpc_listen_address = &quot;127.0.0.1:8000&quot;

# Whether to listen with TLS or plain TCP
serve_tls = false

# Path to DER-formatted PKCS#12 archive. (Unused if serve_tls=false)
# This can be created using openssl:
# openssl pkcs12 -export -out identity.pfx -inkey key.pem -in cert.pem -certfile chain_certs.pem
tls_identity_path = &quot;~/.config/darkfi/darkfid_identity.pfx&quot;

# Password for the created TLS identity. (Unused if serve_tls=false)
tls_identity_password = &quot;FOOBAR&quot;

# The endpoint to a gatewayd protocol API
gateway_protocol_url = &quot;tcp://185.165.171.77:3333&quot;

# The endpoint to a gatewayd publisher API
gateway_publisher_url = &quot;tcp://185.165.171.77:4444&quot;

# Path to mint.params
mint_params_path = &quot;~/.config/darkfi/mint.params&quot;

# Path to spend.params
spend_params_path = &quot;~/.config/darkfi/spend.params&quot;

# Path to the client database
database_path = &quot;~/.config/darkfi/darkfid_client.db&quot;

# Path to the wallet database
wallet_path = &quot;~/.config/darkfi/darkfid_wallet.db&quot;

# The wallet password
wallet_password = &quot;TEST_PASSWORD&quot;

# The configured cashiers to use.
[[cashiers]]

# Cashier name
name = &quot;testnet.cashier.dark.fi&quot;

# The RPC endpoint for a selected cashier
#rpc_url = &quot;tcp://127.0.0.1:9000&quot;
rpc_url = &quot;tcp://185.165.171.77:9000&quot;

# The selected cashier public key
public_key = &quot;2MezH7FrtzGwtEEeTU8anM2b67Nzfv8XsojggGUavCUd&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="architecture-design"><a class="header" href="#architecture-design">Architecture design</a></h1>
<p>This section of the book shows the software architecture of DarkFi and
the network implementations.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfi-nodes"><a class="header" href="#darkfi-nodes">DarkFi nodes</a></h1>
<p>The core daemon used for wallet management, transaction building, and
general operations is called <code>darkfid</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="clients"><a class="header" href="#clients">Clients</a></h1>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="darkfid-json-rpc-api"><a class="header" href="#darkfid-json-rpc-api">darkfid JSON-RPC API</a></h1>
<h2 id="methods"><a class="header" href="#methods">Methods</a></h2>
<ul>
<li><a href="clients/darkfid_jsonrpc.html#say_hello"><code>say_hello</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#create_wallet"><code>create_wallet</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#key_gen"><code>key_gen</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#get_key"><code>get_key</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#get_keys"><code>get_keys</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#import_keypair"><code>import_keypair</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#export_keypair"><code>export_keypair</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#set_default_address"><code>set_default_address</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#get_balances"><code>get_balances</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#get_token_id"><code>get_token_id</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#features"><code>features</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#deposit"><code>deposit</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#withdraw"><code>withdraw</code></a></li>
<li><a href="clients/darkfid_jsonrpc.html#transfer"><code>transfer</code></a></li>
</ul>
<h3 id="say_hello"><a class="header" href="#say_hello"><code>say_hello</code></a></h3>
<p>Returns a <code>helloworld</code> string.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L208">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;say_hello&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;hello world&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="create_wallet"><a class="header" href="#create_wallet"><code>create_wallet</code></a></h3>
<p>Attempts to initialize a wallet, and returns <code>true</code> upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L216">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;create_wallet&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="key_gen"><a class="header" href="#key_gen"><code>key_gen</code></a></h3>
<p>Attempts to generate a new keypair and returns <code>true</code> upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L227">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;key_gen&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="get_key"><a class="header" href="#get_key"><code>get_key</code></a></h3>
<p>Fetches the main keypair from the wallet and returns it
in an encoded format.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L240">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_key&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;vdNS7oBj7KvsMWWmo9r96SV4SqATLrGsH2a3PGpCfJC&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="get_keys"><a class="header" href="#get_keys"><code>get_keys</code></a></h3>
<p>Fetches all keypairs from the wallet and returns a list of them
in an encoded format.
The first one in the list is the default selected keypair.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L252">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_keys&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [&quot;vdNS7oBj7KvsMWWmo9r96SV4SqATLrGsH2a3PGpCfJC&quot;, &quot;...&quot;], &quot;id&quot;: 1}
</code></pre>
<h3 id="import_keypair"><a class="header" href="#import_keypair"><code>import_keypair</code></a></h3>
<p>Imports a keypair into the wallet with a given path on the filesystem.
Returns <code>true</code> upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L284">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;import_keypair&quot;, &quot;params&quot;: [&quot;/path&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc:&quot; &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="export_keypair"><a class="header" href="#export_keypair"><code>export_keypair</code></a></h3>
<p>Exports the default selected keypair to a given path on the filesystem.
Returns <code>true</code> upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L329">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;export_keypair&quot;, &quot;params&quot;: [&quot;/path&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="set_default_address"><a class="header" href="#set_default_address"><code>set_default_address</code></a></h3>
<p>Sets the default wallet address to the given parameter.
Returns true upon success.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L367">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;set_default_address&quot;, &quot;params&quot;: [&quot;vdNS7oBj7KvsMWWmo9r96SV4SqATLrGsH2a3PGpCfJC&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: true, &quot;id&quot;: 1}
</code></pre>
<h3 id="get_balances"><a class="header" href="#get_balances"><code>get_balances</code></a></h3>
<p>Fetches the known balances from the wallet.
Returns a map of balances, indexed by <code>network</code>, and token ID.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L394">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_balances&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: [{&quot;btc&quot;: [100, &quot;Bitcoin&quot;]}, {...}], &quot;id&quot;: 1}
</code></pre>
<h3 id="get_token_id"><a class="header" href="#get_token_id"><code>get_token_id</code></a></h3>
<p>Generates the internal token ID for a given <code>network</code> and token ticker or address.
Returns the internal representation of the token ID.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L439">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;get_token_id&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;Ht5G1RhkcKnpLVLMhqJc5aqZ4wYUEbxbtZwGCVbgU7DL&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="features"><a class="header" href="#features"><code>features</code></a></h3>
<p>Asks the configured cashier for their supported features.
Returns a map of features received from the requested cashier.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L506">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;features&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: {&quot;network&quot;: [&quot;btc&quot;, &quot;sol&quot;]}, &quot;id&quot;: 1}
</code></pre>
<h3 id="deposit-1"><a class="header" href="#deposit-1"><code>deposit</code></a></h3>
<p>Initializes a DarkFi deposit request for a given <code>network</code>, <code>token</code>,
and <code>publickey</code>.
The public key send here is used so the cashier can know where to send
the newly minted tokens once the deposit is received.
Returns an address to which the caller is supposed to deposit funds.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L530">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;deposit&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;Ht5G1RhkcKnpLVLMhqJc5aqZ4wYUEbxbtZwGCVbgU7DL&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="withdraw-1"><a class="header" href="#withdraw-1"><code>withdraw</code></a></h3>
<p>Initializes a withdraw request for a given <code>network</code>, <code>token</code>, <code>publickey</code>,
and <code>amount</code>.
The publickey send here is the address where the caller wants to receive
the tokens they plan to withdraw.
On request, sends a request to a cashier to get a deposit address, and
then transfers wrapped DarkFitokens to the cashier's wallet. Following that,
the cashier should return a transaction ID of them sending the funds that
are requested for withdrawal.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L604">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;withdraw&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;, &quot;amount&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="transfer"><a class="header" href="#transfer"><code>transfer</code></a></h3>
<p>Transfer a given wrapped DarkFi token amount to the given address.
Returns the transaction ID of the transfer.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/darkfid/src/main.rs#L724">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;transfer&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;dToken&quot;, &quot;address&quot;, &quot;amount&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID&quot;, &quot;id&quot;: 1}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="cashierd-json-rpc-api"><a class="header" href="#cashierd-json-rpc-api">cashierd JSON-RPC API</a></h1>
<h2 id="methods-1"><a class="header" href="#methods-1">Methods</a></h2>
<ul>
<li><a href="clients/cashierd_jsonrpc.html#deposit"><code>deposit</code></a></li>
<li><a href="clients/cashierd_jsonrpc.html#withdraw"><code>withdraw</code></a></li>
<li><a href="clients/cashierd_jsonrpc.html#features"><code>features</code></a></li>
</ul>
<h3 id="deposit-2"><a class="header" href="#deposit-2"><code>deposit</code></a></h3>
<p>Executes a deposit request given <code>network</code> and <code>token_id</code>.
Returns the address where the deposit shall be transferred to.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L399">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;deposit&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;Ht5G1RhkcKnpLVLMhqJc5aqZ4wYUEbxbtZwGCVbgU7DL&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="withdraw-2"><a class="header" href="#withdraw-2"><code>withdraw</code></a></h3>
<p>Executes a withdraw request given <code>network</code>, <code>token_id</code>, <code>publickey</code>
and <code>amount</code>. <code>publickey</code> is supposed to correspond to <code>network</code>.
Returns the transaction ID of the processed withdraw.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L530">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;withdraw&quot;, &quot;params&quot;: [&quot;network&quot;, &quot;token&quot;, &quot;publickey&quot;, &quot;amount&quot;], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: &quot;txID&quot;, &quot;id&quot;: 1}
</code></pre>
<h3 id="features-1"><a class="header" href="#features-1"><code>features</code></a></h3>
<p>Returns supported cashier features, like network, listening ports, etc.
<br><sup><a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/cashierd/src/main.rs#L617">[src]</a></sup></p>
<pre><code class="language-json">--&gt; {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;method&quot;: &quot;features&quot;, &quot;params&quot;: [], &quot;id&quot;: 1}
&lt;-- {&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;result&quot;: {&quot;network&quot;: [&quot;btc&quot;, &quot;sol&quot;]}, &quot;id&quot;: 1}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zkas"><a class="header" href="#zkas">zkas</a></h1>
<p>zkas is a compiler for the Halo2 zkVM language used in
<a href="https://github.com/darkrenaissance/darkfi">DarkFi</a>.</p>
<p>The current implementation found in the DarkFi repository inside
<a href="https://github.com/darkrenaissance/darkfi/tree/master/src/zkas"><code>src/zkas</code></a>
is the reference compiler and language implementation. It is a
toolchain consisting of a lexer, parser, static and semantic analyzers,
and a binary code compiler.</p>
<p>The
<a href="https://github.com/darkrenaissance/darkfi/blob/master/bin/zkas/src/main.rs"><code>main.rs</code></a>
file shows how this toolchain is put together to produce binary code
from source code.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="zkas-bincode"><a class="header" href="#zkas-bincode">zkas bincode</a></h1>
<p>The bincode design for zkas is the compiled code in the form of a
binary blob, that can be read by a program and fed into the VM.</p>
<p>Our programs consist of three sections: <code>constant</code>, <code>contract</code>, and
<code>circuit</code>. Our bincode represents the same. Additionally, there is
an optional section called <code>.debug</code> which can hold debug info related
to the binary.</p>
<p>We currently keep everything on the same stack, so we avoid having to
deal with different types. Instead, we rely that the compiler does
a proper parse and analysis of the source code, so we are sure that
in the VM, when referenced, the types shall be correct.</p>
<p>The compiled binary blob has the following layout:</p>
<pre><code>MAGIC_BYTES
BINARY_VERSION
.constant
CONSTANT_TYPE CONSTANT_NAME 
CONSTANT_TYPE CONSTANT_NAME 
...
.contract
WITNESS_TYPE
WITNESS_TYPE
...
.circuit
OPCODE ARG_NUM STACK_INDEX ... STACK_INDEX
OPCODE ARG_NUM STACK_INDEX ... STACK_INDEX
...
.debug
TBD
</code></pre>
<p>Integers in the binary are encoded using variable-integer encoding.
See <a href="https://github.com/darkrenaissance/darkfi/blob/master/src/util/serial.rs"><code>serial.rs</code></a>
for our Rust implementation.</p>
<h2 id="magic_bytes"><a class="header" href="#magic_bytes"><code>MAGIC_BYTES</code></a></h2>
<p>The magic bytes are the file signature consisting of four bytes used
to identify the zkas binary code. They consist of:</p>
<blockquote>
<p><code>0x0b</code> <code>0xxx</code> <code>0xb1</code> <code>0x35</code></p>
</blockquote>
<h2 id="binary_version"><a class="header" href="#binary_version"><code>BINARY_VERSION</code></a></h2>
<p>The binary code also contains the binary version to allow parsing
potential different formats in the future.</p>
<blockquote>
<p><code>0x01</code></p>
</blockquote>
<h2 id="constant"><a class="header" href="#constant"><code>.constant</code></a></h2>
<p>The constants in the <code>.constant</code> section are declared with their type
and name, so that the VM knows how to search for the builtin constant
and add it to the stack.</p>
<h2 id="contract"><a class="header" href="#contract"><code>.contract</code></a></h2>
<p>The <code>.contract</code> section holds the circuit witness values in the form
of <code>WITNESS_TYPE</code>. Their stack index is incremented for each witness
as they're kept in order like in the source file. The witnesses
that are of the same type as the circuit itself (typically <code>Base</code>)
will be loaded into the circuit as <em>private values</em> using the Halo2
<code>load_private</code> API.</p>
<h2 id="circuit"><a class="header" href="#circuit"><code>.circuit</code></a></h2>
<p>The <code>.circuit</code> section holds the procedural logic of the ZK proof.
In here we have statements with opcodes that are executed as
understood by the VM. The statements are in the form of:</p>
<blockquote>
<p><code>OPCODE ARG_NUM STACK_INDEX ... STACK_INDEX</code></p>
</blockquote>
<p>where:</p>
<table><thead><tr><th>Element</th><th>Description</th></tr></thead><tbody>
<tr><td><code>OPCODE</code></td><td>The opcode we wish to execute</td></tr>
<tr><td><code>ARG_NUM</code></td><td>The number of arguments given to this opcode</td></tr>
<tr><td></td><td>(Note the VM should be checking the correctness of this as well)</td></tr>
<tr><td><code>STACK_INDEX</code></td><td>The location of the argument on the stack.</td></tr>
<tr><td></td><td>(This is supposed to be repeated <code>ARG_NUM</code> times)</td></tr>
</tbody></table>
<p>In case an opcode has a return value, the value shall be pushed to
the stack and become available for later references.</p>
<h2 id="debug"><a class="header" href="#debug"><code>.debug</code></a></h2>
<p>TBD</p>
<h2 id="decoding-the-bincode"><a class="header" href="#decoding-the-bincode">Decoding the bincode</a></h2>
<p>An example decoder implementation can be found in zkas'
<a href="https://github.com/darkrenaissance/darkfi/blob/master/src/zkas/decoder.rs"><code>decoder.rs</code></a>
module.</p>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="examples-1"><a class="header" href="#examples-1">Examples</a></h1>
<p>This section holds practical and real-world examples of the use for
zkas.</p>
<ul>
<li><a href="zkas/examples/sapling.html">Sapling payment scheme</a></li>
<li><a href="zkas/examples/voting.html">Anonymous voting</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="sapling-payment-scheme"><a class="header" href="#sapling-payment-scheme">Sapling payment scheme</a></h1>
<p>Sapling is a type of transaction which hides both the sender and
receiver data, as well as the amount transacted. This means it allows
a fully private transaction between two addresses.</p>
<p>Generally, the Sapling payment scheme consists of two ZK proofs -
<strong>mint</strong> and <strong>burn</strong>. We use the mint proof to create a new <em>coin</em>
<span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, and we use the burn proof to spend a previously minted <em>coin</em>.</p>
<h2 id="mint-proof"><a class="header" href="#mint-proof">Mint proof</a></h2>
<pre><code>constant &quot;Mint&quot; {
	EcFixedPointShort VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
}

contract &quot;Mint&quot; {
	Base pub_x,
	Base pub_y,
	Base value,
	Base token,
	Base serial,
	Base coin_blind,
	Scalar value_blind,
	Scalar token_blind,
}

circuit &quot;Mint&quot; {
	# Poseidon hash of the coin
	C = poseidon_hash(pub_x, pub_y, value, token, serial, coin_blind);
	constrain_instance(C);

	# Pedersen commitment for coin's value
	vcv = ec_mul_short(value, VALUE_COMMIT_VALUE);
	vcr = ec_mul(value_blind, VALUE_COMMIT_RANDOM);
	value_commit = ec_add(vcv, vcr);
	# Since the value commit is a curve point, we fetch its coordinates
	# and constrain them:
	value_commit_x = ec_get_x(value_commit);
	value_commit_y = ec_get_y(value_commit);
	constrain_instance(value_commit_x);
	constrain_instance(value_commit_y);

	# Pedersen commitment for coin's token ID
	tcv = ec_mul_short(token, VALUE_COMMIT_VALUE);
	tcr = ec_mul(token_blind, VALUE_COMMIT_RANDOM);
	token_commit = ec_add(tcv, tcr);
	# Since token_commit is also a curve point, we'll do the same
	# coordinate dance:
	token_commit_x = ec_get_x(token_commit);
	token_commit_y = ec_get_y(token_commit);
	constrain_instance(token_commit_x);
	constrain_instance(token_commit_y);

	# At this point we've enforced all of our public inputs.
}
</code></pre>
<p>As you can see, the <code>Mint</code> proof basically consists of three
operations.  First one is hashing the <em>coin</em> <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, and after that,
we create <em>Pedersen commitments</em><sup class="footnote-reference"><a href="#1">1</a></sup> for both the coin's <strong>value</strong>
and the coin's <strong>token ID</strong>. On top of the zkas code, we've declared
two constant values that we are going to use for multiplication in
the commitments.</p>
<p>The <code>constrain_instance</code> call can take any of our assigned variables
and enforce a <em>public input</em>. Public inputs are an array (or vector)
of revealed values used by verifiers to verify a zero knowledge
proof. In the above case of the Mint proof, since we have five calls to
<code>constrain_instance</code>, we would also have an array of five elements that
represent these public inputs. The array's order <strong>must match</strong> the
order of the <code>constrain_instance</code> calls since they will be constrained
by their index in the array (which is incremented for every call).</p>
<p>In other words, the vector of public inputs could look like this:</p>
<pre><code>let public_inputs = vec![
    coin,
    *value_coords.x(),
    *value_coords.y(),
    *token_coords.x(),
    *token_coords.y(),
];
</code></pre>
<p>And then the Verifier uses these public inputs to verify a given zero
knowledge proof.</p>
<h3 id="coin"><a class="header" href="#coin">Coin</a></h3>
<p>During the <strong>Mint</strong> phase we create a new coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>, which is bound
to the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>. The coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span> is publicly revealed on the
blockchain and added to the Merkle tree.</p>
<p>Let <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> be the coin's value, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> be the token ID, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span> be the unique
serial number for the coin, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> be a random blinding value. We
create a commitment (hash) of these elements and produce the coin <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span>
in zero-knowledge:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></p>
<p>An interesting thing to keep in mind is that this commitment is
extensible, so one could fit an arbitrary amount of different
attributes inside it.</p>
<h3 id="value-and-token-commitments"><a class="header" href="#value-and-token-commitments">Value and token commitments</a></h3>
<p>To have some value <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span> for our coin, we ensure it's greater than
zero, and then we can create a Pedersen commitment <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
is the blinding factor for the commitment, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are
two predefined generators:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<p>The token ID can be thought of as an attribute we append to our coin
so we can have a differentiation of assets we are working with. In
practice, this allows us to work with different tokens, using the
same zero-knowledge proof circuit. For this token ID, we can also
build a Pedersen commitment <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span> where <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> is the token ID, <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
is the blinding factor, and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> and <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> are predefined generators:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="pseudo-code"><a class="header" href="#pseudo-code">Pseudo-code</a></h2>
<p>Knowing this we can extend our pseudo-code and build the
before-mentioned public inputs for the circuit:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let bincode = include_bytes!(&quot;mint.zk.bin&quot;);
    let zkbin = ZkBinary::decode(bincode)?;

    // ======
    // Prover
    // ======

    // Witness values
    let value = 42;
    let token_id = pallas::Base::from(22);
    let value_blind = pallas::Scalar::random(&amp;mut OsRng);
    let token_blind = pallas::Scalar::random(&amp;mut OsRng);
    let serial = pallas::Base::random(&amp;mut OsRng);
    let coin_blind = pallas::Base::random(&amp;mut OsRng);
    let public_key = PublicKey::random(&amp;mut OsRng);
    let coords = public_key.0.to_affine().coordinates().unwrap();

    let prover_witnesses = vec![
        Witness::Base(Some(*coords.x())),
        Witness::Base(Some(*coords.y())),
        Witness::Base(Some(pallas::Base::from(value))),
        Witness::Base(Some(token_id)),
        Witness::Base(Some(serial)),
        Witness::Base(Some(coin_blind)),
        Witness::Scalar(Some(value_blind)),
        Witness::Scalar(Some(token_blind)),
    ];

    // Create the public inputs
    let msgs = [*coords.x(), *coords.y(), pallas::Base::from(value), token_id, serial, coin_blind];
    let coin = poseidon::Hash::&lt;_, P128Pow5T3, ConstantLength&lt;6&gt;, 3, 2&gt;::init().hash(msgs);

    let value_commit = pedersen_commitment_u64(value, value_blind);
    let value_coords = value_commit.to_affine().coordinates().unwrap();

    let token_commit = pedersen_commitment_scalar(mod_r_p(token_id), token_blind);
    let token_coords = token_commit.to_affine().coordinates().unwrap();

    let public_inputs =
        vec![coin, *value_coords.x(), *value_coords.y(), *token_coords.x(), *token_coords.y()];

    // Create the circuit
    let circuit = ZkCircuit::new(prover_witnesses, zkbin.clone());

    info!(target: &quot;PROVER&quot;, &quot;Building proving key and creating the zero-knowledge proof&quot;);
    let proving_key = ProvingKey::build(11, &amp;circuit);
    let proof = Proof::create(&amp;proving_key, &amp;[circuit], &amp;public_inputs, &amp;mut OsRng)?;

    // ========
    // Verifier
    // ========

    // Construct empty witnesses
    let verifier_witnesses = vec![
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Scalar(None),
        Witness::Scalar(None),
    ];

    // Create the circuit
    let circuit = ZkCircuit::new(verifier_witnesses, zkbin);

    info!(target: &quot;VERIFIER&quot;, &quot;Building verifying key and verifying the zero-knowledge proof&quot;);
    let verifying_key = VerifyingKey::build(11, &amp;circuit);
    proof.verify(&amp;verifying_key, &amp;public_inputs)?;
<span class="boring">}
</span></code></pre></pre>
<h2 id="burn"><a class="header" href="#burn">Burn</a></h2>
<pre><code>constant &quot;Burn&quot; {
	EcFixedPointShort VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
	EcFixedPointBase NULLIFIER_K,
}

contract &quot;Burn&quot; {
	Base secret,
	Base serial,
	Base value,
	Base token,
	Base coin_blind,
	Scalar value_blind,
	Scalar token_blind,
	Uint32 leaf_pos,
	MerklePath path,
	Base signature_secret,
}

circuit &quot;Burn&quot; {
	# Poseidon hash of the nullifier
	nullifier = poseidon_hash(secret, serial);
	constrain_instance(nullifier);

	# Pedersen commitment for coin's value
	vcv = ec_mul_short(value, VALUE_COMMIT_VALUE);
	vcr = ec_mul(value_blind, VALUE_COMMIT_RANDOM);
	value_commit = ec_add(vcv, vcr);
	# Since value_commit is a curve point, we fetch its coordinates
	# and constrain them:
	value_commit_x = ec_get_x(value_commit);
	value_commit_y = ec_get_y(value_commit);
	constrain_instance(value_commit_x);
	constrain_instance(value_commit_y);

	# Pedersen commitment for coin's token ID
	tcv = ec_mul_short(token, VALUE_COMMIT_VALUE);
	tcr = ec_mul(token_blind, VALUE_COMMIT_RANDOM);
	token_commit = ec_add(tcv, tcr);
	# Since token_commit is also a curve point, we'll do the same
	# coordinate dance:
	token_commit_x = ec_get_x(token_commit);
	token_commit_y = ec_get_y(token_commit);
	constrain_instance(token_commit_x);
	constrain_instance(token_commit_y);

	# Coin hash
	pub = ec_mul_base(secret, NULLIFIER_K);
	pub_x = ec_get_x(pub);
	pub_y = ec_get_y(pub);
	C = poseidon_hash(pub_x, pub_y, value, token, serial, coin_blind);

	# Merkle root
	root = calculate_merkle_root(leaf_pos, path, C);
	constrain_instance(root);

	# Finally, we derive a public key for the signature and
	# constrain its coordinates:
	signature_public = ec_mul_base(signature_secret, NULLIFIER_K);
	signature_x = ec_get_x(signature_public);
	signature_y = ec_get_y(signature_public);
	constrain_instance(signature_x);
	constrain_instance(signature_y);

	# At this point we've enforced all of our public inputs.
}
</code></pre>
<p>The <code>Burn</code> proof consists of operations similar to the <code>Mint</code> proof,
with the addition of a <em>Merkle root</em><sup class="footnote-reference"><a href="#2">2</a></sup> calculation. In the same
manner, we are doing a Poseidon hash instance, we're building Pedersen
commitments for the value and token ID, and finally we're doing a
public key derivation.</p>
<p>In this case, our vector of public inputs could look like:</p>
<pre><code>let public_inputs = vec![
    nullifier,
    *value_coords.x(),
    *value_coords.y(),
    *token_coords.x(),
    *token_coords.y(),
    merkle_root,
    *sig_coords.x(),
    *sig_coords.y(),
];
</code></pre>
<h3 id="nullifier"><a class="header" href="#nullifier">Nullifier</a></h3>
<p>When we spend the coin, we must ensure that the value of the coin
cannot be double spent. We call this the <em>Burn</em> phase. The process
relies on a nullifier <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>, which we create using the secret key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>
for the public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span> and a unique random serial <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">ρ</span></span></span></span>. Nullifiers
are unique per coin and prevent double spending:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mclose">)</span></span></span></span></span></p>
<h3 id="merkle-root"><a class="header" href="#merkle-root">Merkle root</a></h3>
<p>We check that the merkle root corresponds to a coin which is in the
Merkle tree <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">ρ</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span></p>
<h3 id="value-and-token-commitments-1"><a class="header" href="#value-and-token-commitments-1">Value and token commitments</a></h3>
<p>Just like we calculated these for the <code>Mint</code> proof, we do the same
here:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.22222em;">V</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span>
<span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">G</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<h2 id="public-key-derivation"><a class="header" href="#public-key-derivation">Public key derivation</a></h2>
<p>We check that the secret key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> corresponds to a public key <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span>.
Usually, we do public key derivation my multiplying our secret key
with a genera tor <span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">G</span></span></span></span>, which results in a public key:</p>
<p><span class="katex-display"><span class="katex"><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">x</span><span class="mord mathnormal">G</span></span></span></span></span></p>
<h2 id="pseudo-code-1"><a class="header" href="#pseudo-code-1">Pseudo-code</a></h2>
<p>Knowing this we can extend our pseudo-code and build the
before-mentioned public inputs for the circuit:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    let bincode = include_bytes!(&quot;burn.zk.bin&quot;);
    let zkbin = ZkBinary::decode(bincode)?;

    // ======
    // Prover
    // ======

    // Witness values
    let value = 42;
    let token_id = pallas::Base::from(22);
    let value_blind = pallas::Scalar::random(&amp;mut OsRng);
    let token_blind = pallas::Scalar::random(&amp;mut OsRng);
    let serial = pallas::Base::random(&amp;mut OsRng);
    let coin_blind = pallas::Base::random(&amp;mut OsRng);
    let secret = SecretKey::random(&amp;mut OsRng);
    let sig_secret = SecretKey::random(&amp;mut OsRng);

    // Build the coin
    let coin2 = {
        let coords = PublicKey::from_secret(secret).0.to_affine().coordinates().unwrap();
        let messages =
            [*coords.x(), *coords.y(), pallas::Base::from(value), token_id, serial, coin_blind];

        poseidon::Hash::&lt;_, P128Pow5T3, ConstantLength&lt;6&gt;, 3, 2&gt;::init().hash(messages)
    };

    // Fill the merkle tree with some random coins that we want to witness,
    // and also add the above coin.
    let mut tree = BridgeTree::&lt;MerkleNode, 32&gt;::new(100);
    let coin0 = pallas::Base::random(&amp;mut OsRng);
    let coin1 = pallas::Base::random(&amp;mut OsRng);
    let coin3 = pallas::Base::random(&amp;mut OsRng);

    tree.append(&amp;MerkleNode(coin0));
    tree.witness();
    tree.append(&amp;MerkleNode(coin1));
    tree.append(&amp;MerkleNode(coin2));
    tree.witness();
    tree.append(&amp;MerkleNode(coin3));
    tree.witness();

    let (leaf_pos, merkle_path) = tree.authentication_path(&amp;MerkleNode(coin2)).unwrap();
    let leaf_pos: u64 = leaf_pos.into();
    let leaf_pos = leaf_pos as u32;

    let prover_witnesses = vec![
        Witness::Base(Some(secret.0)),
        Witness::Base(Some(serial)),
        Witness::Base(Some(pallas::Base::from(value))),
        Witness::Base(Some(token_id)),
        Witness::Base(Some(coin_blind)),
        Witness::Scalar(Some(value_blind)),
        Witness::Scalar(Some(token_blind)),
        Witness::Uint32(Some(leaf_pos)),
        Witness::MerklePath(Some(merkle_path.try_into().unwrap())),
        Witness::Base(Some(sig_secret.0)),
    ];

    // Create the public inputs
    let nullifier = [secret.0, serial];
    let nullifier =
        poseidon::Hash::&lt;_, P128Pow5T3, ConstantLength&lt;2&gt;, 3, 2&gt;::init().hash(nullifier);

    let value_commit = pedersen_commitment_u64(value, value_blind);
    let value_coords = value_commit.to_affine().coordinates().unwrap();

    let token_commit = pedersen_commitment_scalar(mod_r_p(token_id), token_blind);
    let token_coords = token_commit.to_affine().coordinates().unwrap();

    let sig_pubkey = PublicKey::from_secret(sig_secret);
    let sig_coords = sig_pubkey.0.to_affine().coordinates().unwrap();

    let merkle_root = tree.root();

    let public_inputs = vec![
        nullifier,
        *value_coords.x(),
        *value_coords.y(),
        *token_coords.x(),
        *token_coords.y(),
        merkle_root.0,
        *sig_coords.x(),
        *sig_coords.y(),
    ];

    // Create the circuit
    let circuit = ZkCircuit::new(prover_witnesses, zkbin.clone());

    info!(target: &quot;PROVER&quot;, &quot;Building proving key and creating the zero-knowledge proof&quot;);
    let proving_key = ProvingKey::build(11, &amp;circuit);
    let proof = Proof::create(&amp;proving_key, &amp;[circuit], &amp;public_inputs, &amp;mut OsRng)?;

    // ========
    // Verifier
    // ========

    // Construct empty witnesses
    let verifier_witnesses = vec![
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Base(None),
        Witness::Scalar(None),
        Witness::Scalar(None),
        Witness::Uint32(None),
        Witness::MerklePath(None),
        Witness::Base(None),
    ];

    // Create the circuit
    let circuit = ZkCircuit::new(verifier_witnesses, zkbin);

    info!(target: &quot;VERIFIER&quot;, &quot;Building verifying key and verifying the zero-knowledge proof&quot;);
    let verifying_key = VerifyingKey::build(11, &amp;circuit);
    proof.verify(&amp;verifying_key, &amp;public_inputs)?;
<span class="boring">}
</span></code></pre></pre>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>See section 3: <em>The Commitment Scheme</em> of Torben Pryds Pedersen's
<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-46766-1_9.pdf">paper on Non-Interactive and
Information-Theoretic Secure Verifiable Secret
Sharing</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree on Wikipedia</a></p>
</div>
<div style="break-before: page; page-break-before: always;"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anonymous-voting"><a class="header" href="#anonymous-voting">Anonymous voting</a></h1>
<p>Anonymous voting<sup class="footnote-reference"><a href="#1">1</a></sup> is a type of voting process where users can
vote without revealing their identity, by proving they are accepted
as valid voters.</p>
<p>The proof enables user privacy and allows for fully anonymous voting.</p>
<p>The starting point is a Merkle proof<sup class="footnote-reference"><a href="#2">2</a></sup>, which efficiently proves that
a voter's key belongs to a Merkle tree. However, using this proof alone
would allow the organizer of a process to correlate each vote envelope
with its voter's key on the database, so votes wouldn't be secret.</p>
<h2 id="vote-proof"><a class="header" href="#vote-proof">Vote proof</a></h2>
<pre><code>constant &quot;Vote&quot; {
	EcFixedPoint VALUE_COMMIT_VALUE,
	EcFixedPoint VALUE_COMMIT_RANDOM,
	EcFixedPoint NULLIFIER_K,
}

contract &quot;Vote&quot; {
	Base process_id_0,
	Base process_id_1,
	Base secret_key,
	Base vote,
	Scalar vote_blind,
	Uint32 leaf_pos,
	MerklePath path,
}

circuit &quot;Vote&quot; {
	# Nullifier hash
	process_id = poseidon_hash(process_id_0, process_id_1);
	nullifier = poseidon_hash(secret_key, process_id);
	constrain_instance(nullifier);

	# Public key derivation and hashing
	public_key = ec_mul_base(secret_key, NULLIFIER_K);
	public_x = ec_get_x(public_key);
	public_y = ec_get_y(public_key);
	pk_hash = poseidon_hash(public_x, public_y);

	# Merkle root
	root = calculate_merkle_root(leaf_pos, path, pk_hash);
	constrain_instance(root);

	# Pedersen commitment for vote
	vcv = ec_mul_short(vote, VALUE_COMMIT_VALUE);
	vcr = ec_mul(vote_blind, VALUE_COMMIT_RANDOM);
	vote_commit = ec_add(vcv, vcr);
	# Since vote_commit is a curve point, we fetch its coordinates
	# and constrain_them:
	vote_commit_x = ec_get_x(vote_commit);
	vote_commit_y = ec_get_y(vote_commit);
	constrain_instance(vote_commit_x);
	constrain_instance(vote_commit_y);
}
</code></pre>
<p>Our proof consists of four main operation. First we are hashing the
<em>nullifier</em> using our secret key and the hashed process ID. Next,
we derive our public key and hash it. Following, we take this hash
and create a Merkle proof that it is indeed contained in the given
Merkle tree. And finally, we create a <em>Pedersen commitment</em><sup class="footnote-reference"><a href="#3">3</a></sup>
for the vote choice itself.</p>
<p>Our vector of public inputs can look like this:</p>
<pre><code>let public_inputs = vec![
    nullifier,
    merkle_root,
    *vote_coords.x(),
    *vote_coords.y(),
]
</code></pre>
<p>And then the Verifier uses these public inputs to verify the given
zero-knowledge proof.</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>Specification taken from <a href="https://docs.vocdoni.io/architecture/protocol/anonymous-voting/zk-census-proof.html">vocdoni franchise proof</a></p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p><a href="https://en.wikipedia.org/wiki/Merkle_tree">Merkle tree on Wikipedia</a></p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>See section 3: <em>The Commitment Scheme</em> of Torben Pryds Pedersen's
<a href="https://link.springer.com/content/pdf/10.1007%2F3-540-46766-1_9.pdf">paper on Non-Interactive and
Information-Theoretic Secure Verifiable Secret
Sharing</a></p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </body>
</html>
