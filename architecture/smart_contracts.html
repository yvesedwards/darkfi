<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>The DarkFi Book</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">DarkFi</a></li><li class="chapter-item expanded "><a href="../IDEOLOGY.html"><strong aria-hidden="true">1.</strong> Ideology</a></li><li class="chapter-item expanded "><a href="../development.html"><strong aria-hidden="true">2.</strong> Development</a></li><li class="chapter-item expanded "><a href="../portranges.html"><strong aria-hidden="true">3.</strong> Port ranges</a></li><li class="chapter-item expanded "><a href="../architecture/architecture.html"><strong aria-hidden="true">4.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../architecture/overview.html"><strong aria-hidden="true">4.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../architecture/layers.html"><strong aria-hidden="true">4.2.</strong> Layers</a></li><li class="chapter-item expanded "><a href="../architecture/anonymous_assets.html"><strong aria-hidden="true">4.3.</strong> Anonymous Assets</a></li><li class="chapter-item expanded "><a href="../architecture/blockchain.html"><strong aria-hidden="true">4.4.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="../architecture/dna.html"><strong aria-hidden="true">4.5.</strong> DNA</a></li><li class="chapter-item expanded "><a href="../architecture/smart_contracts.html" class="active"><strong aria-hidden="true">4.6.</strong> Smart Contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../clients/clients.html"><strong aria-hidden="true">5.</strong> Client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../clients/darkfid_jsonrpc.html"><strong aria-hidden="true">5.1.</strong> darkfid JSON-RPC API</a></li><li class="chapter-item expanded "><a href="../clients/cashierd_jsonrpc.html"><strong aria-hidden="true">5.2.</strong> cashierd JSON-RPC API</a></li></ol></li><li class="chapter-item expanded "><a href="../zkas/zkas.html"><strong aria-hidden="true">6.</strong> zkas</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/bincode.html"><strong aria-hidden="true">6.1.</strong> Bincode</a></li><li class="chapter-item expanded "><a href="../zkas/examples.html"><strong aria-hidden="true">6.2.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../zkas/examples/sapling.html"><strong aria-hidden="true">6.2.1.</strong> Sapling scheme</a></li><li class="chapter-item expanded "><a href="../zkas/examples/voting.html"><strong aria-hidden="true">6.2.2.</strong> Anonymous voting</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../misc/misc.html"><strong aria-hidden="true">7.</strong> Miscellaneous tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/vanityaddr.html"><strong aria-hidden="true">7.1.</strong> vanityaddr</a></li><li class="chapter-item expanded "><a href="../misc/ircd.html"><strong aria-hidden="true">7.2.</strong> ircd</a></li><li class="chapter-item expanded "><a href="../misc/tau.html"><strong aria-hidden="true">7.3.</strong> tau</a></li><li class="chapter-item expanded "><a href="../misc/dnetview.html"><strong aria-hidden="true">7.4.</strong> dnetview</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/learn.html"><strong aria-hidden="true">8.</strong> Learn</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/research.html"><strong aria-hidden="true">8.1.</strong> Research</a></li><li class="chapter-item expanded "><a href="../learn/zk_explainer.html"><strong aria-hidden="true">8.2.</strong> ZK explainer</a></li><li class="chapter-item expanded "><a href="../learn/dchat/dchat.html"><strong aria-hidden="true">8.3.</strong> Dchat</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/deployment/part-1.html"><strong aria-hidden="true">8.3.1.</strong> Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/deployment/getting-started.html"><strong aria-hidden="true">8.3.1.1.</strong> Getting started</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/writing-a-daemon.html"><strong aria-hidden="true">8.3.1.2.</strong> Writing a daemon</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/sessions.html"><strong aria-hidden="true">8.3.1.3.</strong> Sessions</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/settings.html"><strong aria-hidden="true">8.3.1.4.</strong> Settings</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/error-handling.html"><strong aria-hidden="true">8.3.1.5.</strong> Error handling</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/start-run-stop.html"><strong aria-hidden="true">8.3.1.6.</strong> Start-Run-Stop</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/seed-node.html"><strong aria-hidden="true">8.3.1.7.</strong> Seed</a></li><li class="chapter-item expanded "><a href="../learn/dchat/deployment/deploy.html"><strong aria-hidden="true">8.3.1.8.</strong> Deploy</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/part-2.html"><strong aria-hidden="true">8.3.2.</strong> Creating dchat</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/message.html"><strong aria-hidden="true">8.3.2.1.</strong> Message</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/protocols.html"><strong aria-hidden="true">8.3.2.2.</strong> Protocols</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/protocol-dchat.html"><strong aria-hidden="true">8.3.2.3.</strong> ProtocolDchat</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/register-protocol.html"><strong aria-hidden="true">8.3.2.4.</strong> Register protocol</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/sending-messages.html"><strong aria-hidden="true">8.3.2.5.</strong> Sending messages</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/ui.html"><strong aria-hidden="true">8.3.2.6.</strong> Slap on a UI</a></li><li class="chapter-item expanded "><a href="../learn/dchat/creating-dchat/using-dchat.html"><strong aria-hidden="true">8.3.2.7.</strong> Using dchat</a></li></ol></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/part-3.html"><strong aria-hidden="true">8.3.3.</strong> Net tools</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/jsonrpcinterface.html"><strong aria-hidden="true">8.3.3.1.</strong> RPC interface</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/accept-addr.html"><strong aria-hidden="true">8.3.3.2.</strong> Accept addr</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/pong.html"><strong aria-hidden="true">8.3.3.3.</strong> Adding methods</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/server.html"><strong aria-hidden="true">8.3.3.4.</strong> RPC server</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/get-info.html"><strong aria-hidden="true">8.3.3.5.</strong> get_info</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/using-dnetview.html"><strong aria-hidden="true">8.3.3.6.</strong> Using dnetview</a></li><li class="chapter-item expanded "><a href="../learn/dchat/network-tools/debug.html"><strong aria-hidden="true">8.3.3.7.</strong> Debugging</a></li></ol></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <!-- Make the book title only appear if it is *not* the chapter title as well -->
                    <h1 id="book-title" class="menu-title">The DarkFi Book</h1>
                    <script type="text/javascript">
                        var bookTitleElement = document.getElementById('book-title')
                        var bookTitle = 'The DarkFi Book';
                        var chapterTitle = 'Smart Contracts';
                        if (bookTitle === chapterTitle) {
                            bookTitleElement.innerText = null;
                            document.title = bookTitle;
                        }
                    </script>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h1 id="anonymous-smart-contracts"><a class="header" href="#anonymous-smart-contracts">Anonymous Smart Contracts</a></h1>
<p>Every full node is a <strong>verifier</strong>.</p>
<p><strong>Prover</strong> is the person executing the smart contract function on their secret witness data.
They are also verifiers in our model.</p>
<p>Lets take a pseudocode smart contract:</p>
<pre><code>contract Dao {
    # 1: the DAO's global state
    dao_bullas = DaoBulla[]
    proposal_bullas = ProposalBulla[]
    proposal_nulls = ProposalNull[]

    # 2. a public smart contract function
    #    there can be many of these
    fn mint(...) {
        ...
    }

    ...
}
</code></pre>
<h2 id="global-smart-contract-state"><a class="header" href="#global-smart-contract-state">Global Smart Contract State</a></h2>
<p>Internally we represent this smart contract like this:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    // Corresponds to 1. above, the global state
    struct State {
        dao_bullas: Vec&lt;DaoBulla&gt;,
        proposal_bullas: Vec&lt;ProposalBulla&gt;,
        proposal_nulls: Vec&lt;ProposalNull&gt;
    }

    // Corresponds to 2. mint()
    mod mint {
        // Prover specific
        struct Builder {
            ...
            // secret witness values for prover
            ...
        }

        impl Builder {
            fn new(...) -&gt; Self {
                ...
            }

            fn build() -&gt; FuncCall {
                ...
            }
        }

        // Verifier code
        struct CallData {
            ...
            // contains the function call data
            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>There is a pipeline where the prover runs <code>Builder::build()</code> to create the <code>FuncCall</code> object that
is then broadcast to the verifiers through the p2p network.</p>
<p>The <code>CallData</code> usually is the public values exported from a ZK proof. Essentially it is the data
used by the verifier to check the function call for <code>DAO::mint()</code>.</p>
<h2 id="atomic-transactions"><a class="header" href="#atomic-transactions">Atomic Transactions</a></h2>
<p>Transactions represent several function call invocations that are atomic. If any function call fails,
the entire tx is rejected. Additionally some smart contracts might impose additional conditions
on the transaction's structure or other function calls (such as their call data).</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Transaction {
    func_calls: Vec&lt;FuncCall&gt;
}
<span class="boring">}
</span></code></pre></pre>
<p>Function calls represent mutations of the current active state to a new state.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct FuncCall {
    contract_id: ContractId,
    func_id: FuncId,
    call_data: Box&lt;dyn Any&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>contract_id</code> corresponds to the top level module for the contract which
includes the global <code>State</code>.</p>
<p>The <code>func_id</code> of a function call corresponds to predefined objects in the submodules:</p>
<ul>
<li><code>Builder</code> creates the anonymized <code>CallData</code>. Ran by the prover.</li>
<li><code>CallData</code> is the parameters used by the anonymized function call invocation.
Verifiers have this.</li>
<li><code>state_transition()</code> that runs the function call on the current state using the <code>CallData</code>.</li>
<li><code>apply()</code> commits the update to the current state taking it to the next state.</li>
</ul>
<p>An example of a <code>contract_id</code> could represent <code>DAO</code> or <code>Money</code>. Examples of <code>func_id</code> could
represent <code>DAO::mint()</code> or <code>Money::transfer()</code>.</p>
<p>Each function call invocation is ran using its own <code>state_transition()</code> function.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    ...

    // DAO::mint() in the smart contract pseudocode
    mod mint {
        ...

        fn state_transition(states: &amp;StateRegistry, func_call_index: usize, parent_tx: &amp;Transaction) -&gt; Result&lt;Update&gt; {
            // we could also change the state_transition() function signature
            // so we pass the func_call itself in
            let func_call = parent_tx.func_calls[func_call_index];
            let call_data = func_call.call_data;
            // It's useful to have the func_call_index within parent_tx because
            // we might want to enforce that it appears at a certain index exactly.
            // So we know the tx is well formed.

            // we can elide this with macro magic
            assert_eq((&amp;**call_data).type_id(), TypeId::of::&lt;CallData&gt;());
            let func_call = func_call.call_data.downcast_ref::&lt;CallData&gt;();

            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>The <code>state_transition()</code> has access to the entire atomic transaction to enforce correctness. For example
chaining of function calls is used by the <code>DAO::exec()</code> smart contract function to execute moving money out
of the treasury using <code>Money::transfer()</code> within the same transaction.</p>
<p>Additionally <code>StateRegistry</code> gives smart contracts access to the global states of all smart contracts on the network,
which is needed for some contracts.</p>
<p>Note that during this step, the state is <em>not</em> modified. Modification happens after the <code>state_transition()</code> is run
for all function call invocations within the transaction. Assuming they all pass successfully, the updates are then
applied at the end. This ensures atomicity property of transactions.</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>mod dao_contract {
    ...

    // DAO::mint() in the smart contract pseudocode
    mod mint {
        ...

        // StateRegistry is mutable
        fn apply(states: &amp;mut StateRegistry, update: Update) {
            ...
        }
    }
}
<span class="boring">}
</span></code></pre></pre>
<p>The transaction verification pipeline roughly looks like this:</p>
<ol>
<li>Loop through all function call invocations within the transaction:
<ol>
<li>Lookup their respective <code>state_transition()</code> function based off their <code>contract_id</code> and <code>func_id</code>.
The <code>contract_id</code> and <code>func_id</code> corresponds to the contract and specific function, such as <code>DAO::mint()</code>.</li>
<li>Call the <code>state_transition()</code> function and store the update. Halt if this function fails.</li>
</ol>
</li>
<li>Loop through all updates
<ol>
<li>Lookup specific <code>apply()</code> function based off the <code>contract_id</code> and <code>func_id</code>.</li>
<li>Call <code>apply(update)</code> to finalize the change.</li>
</ol>
</li>
</ol>
<h2 id="parallelisation-techniques"><a class="header" href="#parallelisation-techniques">Parallelisation Techniques</a></h2>
<p>Since verification is done through <code>state_transition()</code> which returns an update that is then committed
to the state using <code>apply()</code>, we can verify all transactions in a block in parallel.</p>
<p>To enable calling another transaction within the same block (such as flashloans), we can add a special
depends field within the tx that makes a tx wait on another tx before being allowed to verify.
This causes a small deanonymization to occur but brings a massive scalability benefit
to the entire system.</p>
<p>ZK proof verification should be done automatically by the system. Any proof that fails marks the entire
tx as invalid, and the tx is discarded. This should also be parallelized.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../architecture/dna.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../clients/clients.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../architecture/dna.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../clients/clients.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
